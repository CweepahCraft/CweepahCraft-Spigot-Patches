From 0c8e23ab974a932c5fe4a44a9aefbda4cd3a133a Mon Sep 17 00:00:00 2001
From: Jacob Martin <jjm_223@hotmail.com>
Date: Sun, 3 Sep 2017 10:33:21 -0500
Subject: [PATCH] Fire InventoryClickEvent when using the recipe book


diff --git a/nms-patches/AutoRecipe.patch b/nms-patches/AutoRecipe.patch
new file mode 100644
index 0000000..2d4c353
--- /dev/null
+++ b/nms-patches/AutoRecipe.patch
@@ -0,0 +1,82 @@
+--- a/net/minecraft/server/AutoRecipe.java
++++ b/net/minecraft/server/AutoRecipe.java
+@@ -8,6 +8,12 @@
+ import org.apache.logging.log4j.LogManager;
+ import org.apache.logging.log4j.Logger;
+ 
++// CweepahCraft start
++import org.bukkit.craftbukkit.event.CraftEventFactory;
++import org.bukkit.event.inventory.ClickType;
++import org.bukkit.event.inventory.InventoryAction;
++// CweepahCraft end
++
+ public class AutoRecipe {
+ 
+     private final Logger a = LogManager.getLogger();
+@@ -19,6 +25,8 @@
+     private InventoryCrafting g;
+     private List<Slot> h;
+ 
++    private int slotOffset; // CweepahCraft
++
+     public AutoRecipe() {}
+ 
+     public void a(EntityPlayer entityplayer, @Nullable IRecipe irecipe, boolean flag) {
+@@ -34,9 +42,11 @@
+             if (container instanceof ContainerWorkbench) {
+                 this.f = ((ContainerWorkbench) container).resultInventory;
+                 this.g = ((ContainerWorkbench) container).craftInventory;
++                slotOffset = 1; // CweepahCraft
+             } else if (container instanceof ContainerPlayer) {
+                 this.f = ((ContainerPlayer) container).resultInventory;
+                 this.g = ((ContainerPlayer) container).craftInventory;
++                slotOffset = 0; // CweepahCraft
+             }
+ 
+             if (this.f != null && this.g != null) {
+@@ -59,11 +69,12 @@
+ 
+     private void a() {
+         PlayerInventory playerinventory = this.c.inventory;
++        boolean cleared = false; // CweepahCraft - only clear result once if contents are modified
+ 
+         for (int i = 0; i < this.g.getSize(); ++i) {
+             ItemStack itemstack = this.g.getItem(i);
+ 
+-            if (!itemstack.isEmpty()) {
++            if (!itemstack.isEmpty() && CraftEventFactory.handleInventoryClickEvent(this.c, i + 1 /* slot 0 is the result */, ClickType.AUTO_RECIPE, InventoryAction.AUTO_RECIPE)) { // CweepahCraft - Call InventoryClickEvent for this
+                 while (itemstack.getCount() > 0) {
+                     int j = playerinventory.firstPartial(itemstack);
+ 
+@@ -77,11 +88,18 @@
+                     playerinventory.c(j, itemstack1);
+                     this.g.splitStack(i, 1);
+                 }
++
++                // CweepahCraft start
++                if (!cleared) {
++                    this.f.clear(); // moved up from end of this method
++                    cleared = true;
++                }
++                // CweepahCraft end
+             }
+         }
+ 
+-        this.g.clear();
+-        this.f.clear();
++        // this.g.clear(); // CweepahCraft - Unnecessary; items are removed above as needed
++        // this.f.clear(); // CweepahCraft - moved up
+     }
+ 
+     private void b() {
+@@ -179,7 +197,9 @@
+                     ++l;
+                 } else {
+                     for (int k1 = 0; k1 < i; ++k1) {
+-                        this.a(slot, itemstack);
++                        if (CraftEventFactory.handleInventoryClickEvent(this.c, slot.rawSlotIndex, ClickType.AUTO_RECIPE, InventoryAction.AUTO_RECIPE) && CraftEventFactory.handleInventoryClickEvent(this.c, this.c.inventory.c(itemstack) + slotOffset, ClickType.AUTO_RECIPE, InventoryAction.AUTO_RECIPE)) { // CweepahCraft - Call InventoryClickEvent for this
++                            this.a(slot, itemstack);
++                        }
+                     }
+ 
+                     ++l;
diff --git a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
index 4385cd9..705689f 100644
--- a/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
+++ b/src/main/java/org/bukkit/craftbukkit/event/CraftEventFactory.java
@@ -28,6 +28,7 @@ import org.bukkit.craftbukkit.entity.CraftEntity;
 import org.bukkit.craftbukkit.entity.CraftLivingEntity;
 import org.bukkit.craftbukkit.entity.CraftPlayer;
 import org.bukkit.craftbukkit.inventory.CraftInventoryCrafting;
+import org.bukkit.craftbukkit.inventory.CraftInventoryView;
 import org.bukkit.craftbukkit.inventory.CraftItemStack;
 import org.bukkit.craftbukkit.inventory.CraftMetaBook;
 import org.bukkit.craftbukkit.util.CraftDamageSource;
@@ -53,10 +54,7 @@ import org.bukkit.event.entity.*;
 import org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason;
 import org.bukkit.event.entity.EntityDamageEvent.DamageCause;
 import org.bukkit.event.entity.EntityDamageEvent.DamageModifier;
-import org.bukkit.event.inventory.InventoryCloseEvent;
-import org.bukkit.event.inventory.InventoryOpenEvent;
-import org.bukkit.event.inventory.PrepareAnvilEvent;
-import org.bukkit.event.inventory.PrepareItemCraftEvent;
+import org.bukkit.event.inventory.*;
 import org.bukkit.event.player.*;
 import org.bukkit.event.server.ServerListPingEvent;
 import org.bukkit.inventory.EquipmentSlot;
@@ -887,6 +885,13 @@ public class CraftEventFactory {
         human.activeContainer.transferTo(human.defaultContainer, human.getBukkitEntity());
     }
 
+    public static boolean handleInventoryClickEvent(EntityHuman human, int slot, ClickType clickType, InventoryAction action) {
+        InventoryView view = human.activeContainer.getBukkitView();
+        InventoryClickEvent event = new InventoryClickEvent(view, CraftInventoryView.getSlotType(view, slot), slot, clickType, action);
+        human.world.getServer().getPluginManager().callEvent(event);
+        return !event.isCancelled();
+    }
+
     public static void handleEditBookEvent(EntityPlayer player, ItemStack newBookItem) {
         int itemInHandIndex = player.inventory.itemInHandIndex;
 
-- 
1.9.1

